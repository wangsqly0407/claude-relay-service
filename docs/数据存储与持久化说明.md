# 数据存储与持久化说明

本文档详细说明 Claude Relay Service 的数据存储架构和持久化配置。

## 数据存储位置

### 1. 主要存储：Redis

所有账户管理和 API Keys 数据都存储在 **Redis** 中，包括：

#### API Keys 数据
- `api_key:{id}` - API Key 详细信息（含权限、客户端限制、模型黑名单等）
- `api_key_hash:{hash}` - 哈希到 ID 的快速映射
- `api_key_usage:{keyId}` - 使用统计数据
- `api_key_cost:{keyId}` - 成本统计数据

#### 账户数据（多平台）
- `claude_account:{id}` - Claude 官方账户（加密的 OAuth 数据）
- `claude_console_account:{id}` - Claude Console 账户
- `gemini_account:{id}` - Gemini 账户
- `openai_responses_account:{id}` - OpenAI Responses 账户
- `bedrock_account:{id}` - AWS Bedrock 账户
- `azure_openai_account:{id}` - Azure OpenAI 账户
- `droid_account:{id}` - Droid 账户
- `ccr_account:{id}` - CCR 账户

#### 用户管理
- `user:{id}` - 用户信息
- `user_email:{email}` - 邮箱到用户 ID 映射
- `user_session:{token}` - 用户会话

#### 管理员
- `admin:{id}` - 管理员信息
- `admin_username:{username}` - 用户名映射
- `admin_credentials` - 管理员凭据（从 data/init.json 同步）

#### 会话管理
- `session:{token}` - JWT 会话管理
- `sticky_session:{sessionHash}` - 粘性会话账户绑定
- `session_window:{accountId}` - 账户会话窗口

#### 使用统计
- `usage:daily:{date}:{key}:{model}` - 按日期、Key、模型的使用统计
- `usage:account:{accountId}:{date}` - 按账户的使用统计
- `usage:global:{date}` - 全局使用统计

#### 速率限制
- `rate_limit:{keyId}:{window}` - 速率限制计数器
- `rate_limit_state:{accountId}` - 账户限流状态
- `overload:{accountId}` - 账户过载状态（529 错误）

#### 并发控制
- `concurrency:{accountId}` - Redis Sorted Set 实现的并发计数

#### 并发请求排队
- `concurrency:queue:{apiKeyId}` - API Key 级别的排队计数器
- `concurrency:queue:stats:{apiKeyId}` - 排队统计（entered/success/timeout/cancelled）
- `concurrency:queue:wait_times:{apiKeyId}` - 按 API Key 的等待时间记录
- `concurrency:queue:wait_times:global` - 全局等待时间记录

#### Webhook 配置
- `webhook_config:{id}` - Webhook 配置

#### 用户消息队列
- `user_msg_queue_lock:{accountId}` - 用户消息队列锁
- `user_msg_queue_last:{accountId}` - 上次请求完成时间戳

#### 系统信息
- `system_info` - 系统状态缓存
- `model_pricing` - 模型价格数据

### 2. 本地文件存储

- **管理员初始凭据**: `data/init.json` (通过 `npm run setup` 生成)
- **日志文件**: `logs/` 目录

## 持久化配置

### ✅ Redis 持久化已启用

项目采用 **双重持久化策略**，确保数据安全：

#### 1. RDB 快照（Redis Database）

```yaml
--save 60 1
```

- **工作原理**: 每 60 秒内有至少 1 个写操作时自动保存快照
- **优点**: 紧凑的二进制格式，适合数据恢复和备份
- **用途**: 灾难恢复、定期备份

#### 2. AOF 日志（Append Only File）

```yaml
--appendonly yes --appendfsync everysec
```

- **工作原理**: 记录每个写操作命令到日志文件
- **同步策略**: 每秒同步一次到磁盘（`everysec`）
- **优点**: 数据安全性高，最多丢失 1 秒的数据
- **性能**: 性能和安全性的最佳平衡

#### 3. 完整配置（docker-compose.yml）

```yaml
redis:
  image: redis:7-alpine
  restart: unless-stopped
  volumes:
    - ./redis_data:/data  # 数据持久化到宿主机
  command: redis-server --save 60 1 --appendonly yes --appendfsync everysec
```

### 数据卷挂载

```yaml
volumes:
  - ./redis_data:/data    # Redis 数据持久化
  - ./logs:/app/logs      # 应用日志持久化
  - ./data:/app/data      # 初始化数据（管理员凭据）
```

**持久化位置**：
- **Redis 数据**: `./redis_data/` 目录（包含 RDB 快照和 AOF 日志）
- **应用日志**: `./logs/` 目录
- **初始化数据**: `./data/init.json`

## 数据安全性

### 🔐 加密存储

1. **敏感数据加密**
   - OAuth token、refreshToken、credentials 使用 **AES 加密**存储
   - 加密密钥通过 `ENCRYPTION_KEY` 环境变量配置（32 字符固定长度）

2. **API Key 哈希**
   - 使用 **SHA-256 哈希**存储
   - 支持 O(1) 快速查找（哈希映射优化）

3. **JWT 会话**
   - 使用 JWT 管理用户会话
   - JWT 密钥通过 `JWT_SECRET` 环境变量配置（至少 32 字符）

### 🛡️ 数据丢失风险

- **RDB + AOF 双重保护**: 极低（最多丢失 1 秒数据）
- **灾难场景**: 只有同时发生 Redis 崩溃 + 磁盘故障才会丢失数据
- **重启安全**: 服务重启不会丢失任何数据

## 备份和恢复

### 💾 数据导出工具

```bash
# 导出加密数据（生产环境）
npm run data:export:encrypted

# 导出脱敏数据（用于分享/调试）
npm run data:export:sanitized

# 导出增强数据（含解密，仅开发环境）
npm run data:export:enhanced

# 导出基础数据
npm run data:export
```

### 📥 数据导入工具

```bash
# 导入增强数据
npm run data:import:enhanced

# 导入基础数据
npm run data:import
```

### 🔍 数据调试工具

```bash
# 查看所有 Redis 键
npm run data:debug
```

## 数据迁移

### 跨实例迁移流程（Docker 环境）

1. **源实例导出数据**
   ```bash
   # 进入源服务器的项目目录
   cd /path/to/claude-relay-service

   # 通过 docker-compose 执行导出命令
   docker-compose exec claude-relay npm run data:export:encrypted

   # 导出的文件会保存在项目根目录下（通过 volume 映射）
   # 文件名格式: backup-encrypted-YYYYMMDD-HHMMSS.json
   ls -la backup-*.json
   ```

2. **传输数据文件**
   ```bash
   # 将导出文件传输到目标服务器的项目根目录
   scp backup-encrypted-*.json user@target-server:/path/to/claude-relay-service/
   ```

3. **目标实例导入数据**
   ```bash
   # 进入目标服务器的项目目录
   cd /path/to/claude-relay-service

   # 通过 docker-compose 执行导入命令
   docker-compose exec claude-relay npm run data:import:enhanced
   ```

> **说明**：`/path/to/claude-relay-service/` 是项目的实际部署目录，即包含 `docker-compose.yml` 文件的目录。根据实际情况替换，例如 `/home/user/claude-relay-service/` 或 `/opt/claude-relay-service/`。

### 注意事项

- **加密密钥一致性**: 确保 `ENCRYPTION_KEY` 在源和目标实例保持一致
- **Redis 版本兼容性**: 建议使用相同版本的 Redis
- **数据验证**: 导入后验证关键数据（账户、API Keys）

## 监控和维护

### 📊 Redis 监控

```bash
# 启动 Redis Commander（可选）
docker-compose --profile monitoring up -d

# 访问 Redis Commander
# http://localhost:8081
```

### 🧹 自动清理任务

系统包含多个自动清理任务：

1. **并发计数清理**: 每分钟清理过期并发计数
2. **速率限制清理**: 每 5 分钟清理过期限流状态
3. **临时错误清理**: 自动清理临时错误标记
4. **过期 Key 清理**: 定期清理过期的 API Keys 和会话

### 📝 日志管理

```bash
# 查看日志
docker-compose logs -f claude-relay

# 日志目录结构
logs/
├── claude-relay-*.log         # 应用主日志
├── token-refresh-error.log    # Token 刷新错误
├── webhook-*.log              # Webhook 通知日志
└── http-debug-*.log           # HTTP 调试日志（DEBUG_HTTP_TRAFFIC=true）
```

## 性能优化

### 🚀 缓存策略

1. **多层 LRU 缓存**
   - 解密数据缓存（减少解密开销）
   - 账户信息缓存（减少 Redis 查询）

2. **全局缓存监控**
   - 缓存命中率统计
   - 性能指标分析

### 📈 查询优化

1. **哈希映射优化**: API Key 验证从 O(n) 优化到 O(1) 查找
2. **Redis 管道**: 批量操作使用管道减少网络往返
3. **异步处理**: 统计记录和日志写入采用异步处理

## 常见问题

### Q: Redis 重启后数据会丢失吗？

**A**: 不会。双重持久化机制（RDB + AOF）确保数据安全，重启后会自动加载持久化数据。

### Q: 如何备份数据？

**A**:
1. 使用项目提供的导出工具：`npm run data:export:encrypted`
2. 直接备份 `redis_data/` 目录（包含 RDB 和 AOF 文件）

### Q: 数据加密后如何查看？

**A**:
1. 使用增强导出工具：`npm run data:export:enhanced`（会解密敏感数据）
2. 通过 Web 管理界面查看（已自动解密）

### Q: 如何清理旧数据？

**A**:
1. API Keys 支持过期时间配置，系统自动清理
2. 使用统计数据保留时间通过 `TOKEN_USAGE_RETENTION` 配置（默认 30 天）
3. 手动清理：通过 CLI 工具或 Redis Commander

### Q: Redis 数据量过大怎么办？

**A**:
1. 调整数据保留策略（减少 `TOKEN_USAGE_RETENTION`）
2. 定期导出并清理历史统计数据
3. 使用 Redis 分片或集群（需要修改配置）

## 最佳实践

### ✅ 生产环境建议

1. **定期备份**
   - 每日自动备份 `redis_data/` 目录
   - 每周执行一次 `npm run data:export:encrypted`

2. **监控告警**
   - 监控 Redis 内存使用率
   - 监控磁盘空间（`redis_data/`、`logs/` 目录）
   - 设置 Redis 慢查询日志

3. **安全配置**
   - 设置强 Redis 密码（`REDIS_PASSWORD`）
   - 不要将 Redis 端口暴露到公网
   - 定期轮换 `ENCRYPTION_KEY` 和 `JWT_SECRET`

4. **性能优化**
   - 使用 SSD 存储 Redis 数据
   - 配置合理的 Redis 内存上限（`maxmemory`）
   - 启用 Redis 持久化压缩（默认已启用）

### ⚠️ 注意事项

1. **加密密钥管理**
   - `ENCRYPTION_KEY` 必须是 32 字符固定长度
   - 更改密钥会导致已加密数据无法解密
   - 密钥丢失则所有敏感数据无法恢复

2. **Redis 版本兼容性**
   - 使用 Redis 7.x 版本（docker-compose 配置为 `redis:7-alpine`）
   - 避免在生产环境升级 Redis 大版本

3. **磁盘空间管理**
   - AOF 文件会持续增长，Redis 会定期重写压缩
   - 监控 `redis_data/` 目录大小
   - 预留足够的磁盘空间（建议至少 10GB）

## 相关文档

- [系统架构文档](./architecture.md)
- [本地开发指南](./local-development-guide.md)
- [CLAUDE.md 项目说明](../CLAUDE.md)
