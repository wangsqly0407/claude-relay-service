# æ•°æ®å­˜å‚¨ä¸æŒä¹…åŒ–è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ Claude Relay Service çš„æ•°æ®å­˜å‚¨æ¶æ„å’ŒæŒä¹…åŒ–é…ç½®ã€‚

## æ•°æ®å­˜å‚¨ä½ç½®

### 1. ä¸»è¦å­˜å‚¨ï¼šRedis

æ‰€æœ‰è´¦æˆ·ç®¡ç†å’Œ API Keys æ•°æ®éƒ½å­˜å‚¨åœ¨ **Redis** ä¸­ï¼ŒåŒ…æ‹¬ï¼š

#### API Keys æ•°æ®
- `api_key:{id}` - API Key è¯¦ç»†ä¿¡æ¯ï¼ˆå«æƒé™ã€å®¢æˆ·ç«¯é™åˆ¶ã€æ¨¡å‹é»‘åå•ç­‰ï¼‰
- `api_key_hash:{hash}` - å“ˆå¸Œåˆ° ID çš„å¿«é€Ÿæ˜ å°„
- `api_key_usage:{keyId}` - ä½¿ç”¨ç»Ÿè®¡æ•°æ®
- `api_key_cost:{keyId}` - æˆæœ¬ç»Ÿè®¡æ•°æ®

#### è´¦æˆ·æ•°æ®ï¼ˆå¤šå¹³å°ï¼‰
- `claude_account:{id}` - Claude å®˜æ–¹è´¦æˆ·ï¼ˆåŠ å¯†çš„ OAuth æ•°æ®ï¼‰
- `claude_console_account:{id}` - Claude Console è´¦æˆ·
- `gemini_account:{id}` - Gemini è´¦æˆ·
- `openai_responses_account:{id}` - OpenAI Responses è´¦æˆ·
- `bedrock_account:{id}` - AWS Bedrock è´¦æˆ·
- `azure_openai_account:{id}` - Azure OpenAI è´¦æˆ·
- `droid_account:{id}` - Droid è´¦æˆ·
- `ccr_account:{id}` - CCR è´¦æˆ·

#### ç”¨æˆ·ç®¡ç†
- `user:{id}` - ç”¨æˆ·ä¿¡æ¯
- `user_email:{email}` - é‚®ç®±åˆ°ç”¨æˆ· ID æ˜ å°„
- `user_session:{token}` - ç”¨æˆ·ä¼šè¯

#### ç®¡ç†å‘˜
- `admin:{id}` - ç®¡ç†å‘˜ä¿¡æ¯
- `admin_username:{username}` - ç”¨æˆ·åæ˜ å°„
- `admin_credentials` - ç®¡ç†å‘˜å‡­æ®ï¼ˆä» data/init.json åŒæ­¥ï¼‰

#### ä¼šè¯ç®¡ç†
- `session:{token}` - JWT ä¼šè¯ç®¡ç†
- `sticky_session:{sessionHash}` - ç²˜æ€§ä¼šè¯è´¦æˆ·ç»‘å®š
- `session_window:{accountId}` - è´¦æˆ·ä¼šè¯çª—å£

#### ä½¿ç”¨ç»Ÿè®¡
- `usage:daily:{date}:{key}:{model}` - æŒ‰æ—¥æœŸã€Keyã€æ¨¡å‹çš„ä½¿ç”¨ç»Ÿè®¡
- `usage:account:{accountId}:{date}` - æŒ‰è´¦æˆ·çš„ä½¿ç”¨ç»Ÿè®¡
- `usage:global:{date}` - å…¨å±€ä½¿ç”¨ç»Ÿè®¡

#### é€Ÿç‡é™åˆ¶
- `rate_limit:{keyId}:{window}` - é€Ÿç‡é™åˆ¶è®¡æ•°å™¨
- `rate_limit_state:{accountId}` - è´¦æˆ·é™æµçŠ¶æ€
- `overload:{accountId}` - è´¦æˆ·è¿‡è½½çŠ¶æ€ï¼ˆ529 é”™è¯¯ï¼‰

#### å¹¶å‘æ§åˆ¶
- `concurrency:{accountId}` - Redis Sorted Set å®ç°çš„å¹¶å‘è®¡æ•°

#### å¹¶å‘è¯·æ±‚æ’é˜Ÿ
- `concurrency:queue:{apiKeyId}` - API Key çº§åˆ«çš„æ’é˜Ÿè®¡æ•°å™¨
- `concurrency:queue:stats:{apiKeyId}` - æ’é˜Ÿç»Ÿè®¡ï¼ˆentered/success/timeout/cancelledï¼‰
- `concurrency:queue:wait_times:{apiKeyId}` - æŒ‰ API Key çš„ç­‰å¾…æ—¶é—´è®°å½•
- `concurrency:queue:wait_times:global` - å…¨å±€ç­‰å¾…æ—¶é—´è®°å½•

#### Webhook é…ç½®
- `webhook_config:{id}` - Webhook é…ç½®

#### ç”¨æˆ·æ¶ˆæ¯é˜Ÿåˆ—
- `user_msg_queue_lock:{accountId}` - ç”¨æˆ·æ¶ˆæ¯é˜Ÿåˆ—é”
- `user_msg_queue_last:{accountId}` - ä¸Šæ¬¡è¯·æ±‚å®Œæˆæ—¶é—´æˆ³

#### ç³»ç»Ÿä¿¡æ¯
- `system_info` - ç³»ç»ŸçŠ¶æ€ç¼“å­˜
- `model_pricing` - æ¨¡å‹ä»·æ ¼æ•°æ®

### 2. æœ¬åœ°æ–‡ä»¶å­˜å‚¨

- **ç®¡ç†å‘˜åˆå§‹å‡­æ®**: `data/init.json` (é€šè¿‡ `npm run setup` ç”Ÿæˆ)
- **æ—¥å¿—æ–‡ä»¶**: `logs/` ç›®å½•

## æŒä¹…åŒ–é…ç½®

### âœ… Redis æŒä¹…åŒ–å·²å¯ç”¨

é¡¹ç›®é‡‡ç”¨ **åŒé‡æŒä¹…åŒ–ç­–ç•¥**ï¼Œç¡®ä¿æ•°æ®å®‰å…¨ï¼š

#### 1. RDB å¿«ç…§ï¼ˆRedis Databaseï¼‰

```yaml
--save 60 1
```

- **å·¥ä½œåŸç†**: æ¯ 60 ç§’å†…æœ‰è‡³å°‘ 1 ä¸ªå†™æ“ä½œæ—¶è‡ªåŠ¨ä¿å­˜å¿«ç…§
- **ä¼˜ç‚¹**: ç´§å‡‘çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œé€‚åˆæ•°æ®æ¢å¤å’Œå¤‡ä»½
- **ç”¨é€”**: ç¾éš¾æ¢å¤ã€å®šæœŸå¤‡ä»½

#### 2. AOF æ—¥å¿—ï¼ˆAppend Only Fileï¼‰

```yaml
--appendonly yes --appendfsync everysec
```

- **å·¥ä½œåŸç†**: è®°å½•æ¯ä¸ªå†™æ“ä½œå‘½ä»¤åˆ°æ—¥å¿—æ–‡ä»¶
- **åŒæ­¥ç­–ç•¥**: æ¯ç§’åŒæ­¥ä¸€æ¬¡åˆ°ç£ç›˜ï¼ˆ`everysec`ï¼‰
- **ä¼˜ç‚¹**: æ•°æ®å®‰å…¨æ€§é«˜ï¼Œæœ€å¤šä¸¢å¤± 1 ç§’çš„æ•°æ®
- **æ€§èƒ½**: æ€§èƒ½å’Œå®‰å…¨æ€§çš„æœ€ä½³å¹³è¡¡

#### 3. å®Œæ•´é…ç½®ï¼ˆdocker-compose.ymlï¼‰

```yaml
redis:
  image: redis:7-alpine
  restart: unless-stopped
  volumes:
    - ./redis_data:/data  # æ•°æ®æŒä¹…åŒ–åˆ°å®¿ä¸»æœº
  command: redis-server --save 60 1 --appendonly yes --appendfsync everysec
```

### æ•°æ®å·æŒ‚è½½

```yaml
volumes:
  - ./redis_data:/data    # Redis æ•°æ®æŒä¹…åŒ–
  - ./logs:/app/logs      # åº”ç”¨æ—¥å¿—æŒä¹…åŒ–
  - ./data:/app/data      # åˆå§‹åŒ–æ•°æ®ï¼ˆç®¡ç†å‘˜å‡­æ®ï¼‰
```

**æŒä¹…åŒ–ä½ç½®**ï¼š
- **Redis æ•°æ®**: `./redis_data/` ç›®å½•ï¼ˆåŒ…å« RDB å¿«ç…§å’Œ AOF æ—¥å¿—ï¼‰
- **åº”ç”¨æ—¥å¿—**: `./logs/` ç›®å½•
- **åˆå§‹åŒ–æ•°æ®**: `./data/init.json`

## æ•°æ®å®‰å…¨æ€§

### ğŸ” åŠ å¯†å­˜å‚¨

1. **æ•æ„Ÿæ•°æ®åŠ å¯†**
   - OAuth tokenã€refreshTokenã€credentials ä½¿ç”¨ **AES åŠ å¯†**å­˜å‚¨
   - åŠ å¯†å¯†é’¥é€šè¿‡ `ENCRYPTION_KEY` ç¯å¢ƒå˜é‡é…ç½®ï¼ˆ32 å­—ç¬¦å›ºå®šé•¿åº¦ï¼‰

2. **API Key å“ˆå¸Œ**
   - ä½¿ç”¨ **SHA-256 å“ˆå¸Œ**å­˜å‚¨
   - æ”¯æŒ O(1) å¿«é€ŸæŸ¥æ‰¾ï¼ˆå“ˆå¸Œæ˜ å°„ä¼˜åŒ–ï¼‰

3. **JWT ä¼šè¯**
   - ä½¿ç”¨ JWT ç®¡ç†ç”¨æˆ·ä¼šè¯
   - JWT å¯†é’¥é€šè¿‡ `JWT_SECRET` ç¯å¢ƒå˜é‡é…ç½®ï¼ˆè‡³å°‘ 32 å­—ç¬¦ï¼‰

### ğŸ›¡ï¸ æ•°æ®ä¸¢å¤±é£é™©

- **RDB + AOF åŒé‡ä¿æŠ¤**: æä½ï¼ˆæœ€å¤šä¸¢å¤± 1 ç§’æ•°æ®ï¼‰
- **ç¾éš¾åœºæ™¯**: åªæœ‰åŒæ—¶å‘ç”Ÿ Redis å´©æºƒ + ç£ç›˜æ•…éšœæ‰ä¼šä¸¢å¤±æ•°æ®
- **é‡å¯å®‰å…¨**: æœåŠ¡é‡å¯ä¸ä¼šä¸¢å¤±ä»»ä½•æ•°æ®

## å¤‡ä»½å’Œæ¢å¤

### ğŸ’¾ æ•°æ®å¯¼å‡ºå·¥å…·

```bash
# å¯¼å‡ºåŠ å¯†æ•°æ®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
npm run data:export:encrypted

# å¯¼å‡ºè„±æ•æ•°æ®ï¼ˆç”¨äºåˆ†äº«/è°ƒè¯•ï¼‰
npm run data:export:sanitized

# å¯¼å‡ºå¢å¼ºæ•°æ®ï¼ˆå«è§£å¯†ï¼Œä»…å¼€å‘ç¯å¢ƒï¼‰
npm run data:export:enhanced

# å¯¼å‡ºåŸºç¡€æ•°æ®
npm run data:export
```

### ğŸ“¥ æ•°æ®å¯¼å…¥å·¥å…·

```bash
# å¯¼å…¥å¢å¼ºæ•°æ®
npm run data:import:enhanced

# å¯¼å…¥åŸºç¡€æ•°æ®
npm run data:import
```

### ğŸ” æ•°æ®è°ƒè¯•å·¥å…·

```bash
# æŸ¥çœ‹æ‰€æœ‰ Redis é”®
npm run data:debug
```

## æ•°æ®è¿ç§»

### è·¨å®ä¾‹è¿ç§»æµç¨‹

1. **æºå®ä¾‹å¯¼å‡ºæ•°æ®**
   ```bash
   npm run data:export:encrypted
   ```

2. **ä¼ è¾“æ•°æ®æ–‡ä»¶**
   ```bash
   scp backup-*.json target-server:/path/to/app/
   ```

3. **ç›®æ ‡å®ä¾‹å¯¼å…¥æ•°æ®**
   ```bash
   npm run data:import:enhanced
   ```

### æ³¨æ„äº‹é¡¹

- **åŠ å¯†å¯†é’¥ä¸€è‡´æ€§**: ç¡®ä¿ `ENCRYPTION_KEY` åœ¨æºå’Œç›®æ ‡å®ä¾‹ä¿æŒä¸€è‡´
- **Redis ç‰ˆæœ¬å…¼å®¹æ€§**: å»ºè®®ä½¿ç”¨ç›¸åŒç‰ˆæœ¬çš„ Redis
- **æ•°æ®éªŒè¯**: å¯¼å…¥åéªŒè¯å…³é”®æ•°æ®ï¼ˆè´¦æˆ·ã€API Keysï¼‰

## ç›‘æ§å’Œç»´æŠ¤

### ğŸ“Š Redis ç›‘æ§

```bash
# å¯åŠ¨ Redis Commanderï¼ˆå¯é€‰ï¼‰
docker-compose --profile monitoring up -d

# è®¿é—® Redis Commander
# http://localhost:8081
```

### ğŸ§¹ è‡ªåŠ¨æ¸…ç†ä»»åŠ¡

ç³»ç»ŸåŒ…å«å¤šä¸ªè‡ªåŠ¨æ¸…ç†ä»»åŠ¡ï¼š

1. **å¹¶å‘è®¡æ•°æ¸…ç†**: æ¯åˆ†é’Ÿæ¸…ç†è¿‡æœŸå¹¶å‘è®¡æ•°
2. **é€Ÿç‡é™åˆ¶æ¸…ç†**: æ¯ 5 åˆ†é’Ÿæ¸…ç†è¿‡æœŸé™æµçŠ¶æ€
3. **ä¸´æ—¶é”™è¯¯æ¸…ç†**: è‡ªåŠ¨æ¸…ç†ä¸´æ—¶é”™è¯¯æ ‡è®°
4. **è¿‡æœŸ Key æ¸…ç†**: å®šæœŸæ¸…ç†è¿‡æœŸçš„ API Keys å’Œä¼šè¯

### ğŸ“ æ—¥å¿—ç®¡ç†

```bash
# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f claude-relay

# æ—¥å¿—ç›®å½•ç»“æ„
logs/
â”œâ”€â”€ claude-relay-*.log         # åº”ç”¨ä¸»æ—¥å¿—
â”œâ”€â”€ token-refresh-error.log    # Token åˆ·æ–°é”™è¯¯
â”œâ”€â”€ webhook-*.log              # Webhook é€šçŸ¥æ—¥å¿—
â””â”€â”€ http-debug-*.log           # HTTP è°ƒè¯•æ—¥å¿—ï¼ˆDEBUG_HTTP_TRAFFIC=trueï¼‰
```

## æ€§èƒ½ä¼˜åŒ–

### ğŸš€ ç¼“å­˜ç­–ç•¥

1. **å¤šå±‚ LRU ç¼“å­˜**
   - è§£å¯†æ•°æ®ç¼“å­˜ï¼ˆå‡å°‘è§£å¯†å¼€é”€ï¼‰
   - è´¦æˆ·ä¿¡æ¯ç¼“å­˜ï¼ˆå‡å°‘ Redis æŸ¥è¯¢ï¼‰

2. **å…¨å±€ç¼“å­˜ç›‘æ§**
   - ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
   - æ€§èƒ½æŒ‡æ ‡åˆ†æ

### ğŸ“ˆ æŸ¥è¯¢ä¼˜åŒ–

1. **å“ˆå¸Œæ˜ å°„ä¼˜åŒ–**: API Key éªŒè¯ä» O(n) ä¼˜åŒ–åˆ° O(1) æŸ¥æ‰¾
2. **Redis ç®¡é“**: æ‰¹é‡æ“ä½œä½¿ç”¨ç®¡é“å‡å°‘ç½‘ç»œå¾€è¿”
3. **å¼‚æ­¥å¤„ç†**: ç»Ÿè®¡è®°å½•å’Œæ—¥å¿—å†™å…¥é‡‡ç”¨å¼‚æ­¥å¤„ç†

## å¸¸è§é—®é¢˜

### Q: Redis é‡å¯åæ•°æ®ä¼šä¸¢å¤±å—ï¼Ÿ

**A**: ä¸ä¼šã€‚åŒé‡æŒä¹…åŒ–æœºåˆ¶ï¼ˆRDB + AOFï¼‰ç¡®ä¿æ•°æ®å®‰å…¨ï¼Œé‡å¯åä¼šè‡ªåŠ¨åŠ è½½æŒä¹…åŒ–æ•°æ®ã€‚

### Q: å¦‚ä½•å¤‡ä»½æ•°æ®ï¼Ÿ

**A**:
1. ä½¿ç”¨é¡¹ç›®æä¾›çš„å¯¼å‡ºå·¥å…·ï¼š`npm run data:export:encrypted`
2. ç›´æ¥å¤‡ä»½ `redis_data/` ç›®å½•ï¼ˆåŒ…å« RDB å’Œ AOF æ–‡ä»¶ï¼‰

### Q: æ•°æ®åŠ å¯†åå¦‚ä½•æŸ¥çœ‹ï¼Ÿ

**A**:
1. ä½¿ç”¨å¢å¼ºå¯¼å‡ºå·¥å…·ï¼š`npm run data:export:enhanced`ï¼ˆä¼šè§£å¯†æ•æ„Ÿæ•°æ®ï¼‰
2. é€šè¿‡ Web ç®¡ç†ç•Œé¢æŸ¥çœ‹ï¼ˆå·²è‡ªåŠ¨è§£å¯†ï¼‰

### Q: å¦‚ä½•æ¸…ç†æ—§æ•°æ®ï¼Ÿ

**A**:
1. API Keys æ”¯æŒè¿‡æœŸæ—¶é—´é…ç½®ï¼Œç³»ç»Ÿè‡ªåŠ¨æ¸…ç†
2. ä½¿ç”¨ç»Ÿè®¡æ•°æ®ä¿ç•™æ—¶é—´é€šè¿‡ `TOKEN_USAGE_RETENTION` é…ç½®ï¼ˆé»˜è®¤ 30 å¤©ï¼‰
3. æ‰‹åŠ¨æ¸…ç†ï¼šé€šè¿‡ CLI å·¥å…·æˆ– Redis Commander

### Q: Redis æ•°æ®é‡è¿‡å¤§æ€ä¹ˆåŠï¼Ÿ

**A**:
1. è°ƒæ•´æ•°æ®ä¿ç•™ç­–ç•¥ï¼ˆå‡å°‘ `TOKEN_USAGE_RETENTION`ï¼‰
2. å®šæœŸå¯¼å‡ºå¹¶æ¸…ç†å†å²ç»Ÿè®¡æ•°æ®
3. ä½¿ç”¨ Redis åˆ†ç‰‡æˆ–é›†ç¾¤ï¼ˆéœ€è¦ä¿®æ”¹é…ç½®ï¼‰

## æœ€ä½³å®è·µ

### âœ… ç”Ÿäº§ç¯å¢ƒå»ºè®®

1. **å®šæœŸå¤‡ä»½**
   - æ¯æ—¥è‡ªåŠ¨å¤‡ä»½ `redis_data/` ç›®å½•
   - æ¯å‘¨æ‰§è¡Œä¸€æ¬¡ `npm run data:export:encrypted`

2. **ç›‘æ§å‘Šè­¦**
   - ç›‘æ§ Redis å†…å­˜ä½¿ç”¨ç‡
   - ç›‘æ§ç£ç›˜ç©ºé—´ï¼ˆ`redis_data/`ã€`logs/` ç›®å½•ï¼‰
   - è®¾ç½® Redis æ…¢æŸ¥è¯¢æ—¥å¿—

3. **å®‰å…¨é…ç½®**
   - è®¾ç½®å¼º Redis å¯†ç ï¼ˆ`REDIS_PASSWORD`ï¼‰
   - ä¸è¦å°† Redis ç«¯å£æš´éœ²åˆ°å…¬ç½‘
   - å®šæœŸè½®æ¢ `ENCRYPTION_KEY` å’Œ `JWT_SECRET`

4. **æ€§èƒ½ä¼˜åŒ–**
   - ä½¿ç”¨ SSD å­˜å‚¨ Redis æ•°æ®
   - é…ç½®åˆç†çš„ Redis å†…å­˜ä¸Šé™ï¼ˆ`maxmemory`ï¼‰
   - å¯ç”¨ Redis æŒä¹…åŒ–å‹ç¼©ï¼ˆé»˜è®¤å·²å¯ç”¨ï¼‰

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **åŠ å¯†å¯†é’¥ç®¡ç†**
   - `ENCRYPTION_KEY` å¿…é¡»æ˜¯ 32 å­—ç¬¦å›ºå®šé•¿åº¦
   - æ›´æ”¹å¯†é’¥ä¼šå¯¼è‡´å·²åŠ å¯†æ•°æ®æ— æ³•è§£å¯†
   - å¯†é’¥ä¸¢å¤±åˆ™æ‰€æœ‰æ•æ„Ÿæ•°æ®æ— æ³•æ¢å¤

2. **Redis ç‰ˆæœ¬å…¼å®¹æ€§**
   - ä½¿ç”¨ Redis 7.x ç‰ˆæœ¬ï¼ˆdocker-compose é…ç½®ä¸º `redis:7-alpine`ï¼‰
   - é¿å…åœ¨ç”Ÿäº§ç¯å¢ƒå‡çº§ Redis å¤§ç‰ˆæœ¬

3. **ç£ç›˜ç©ºé—´ç®¡ç†**
   - AOF æ–‡ä»¶ä¼šæŒç»­å¢é•¿ï¼ŒRedis ä¼šå®šæœŸé‡å†™å‹ç¼©
   - ç›‘æ§ `redis_data/` ç›®å½•å¤§å°
   - é¢„ç•™è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ï¼ˆå»ºè®®è‡³å°‘ 10GBï¼‰

## ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿæ¶æ„æ–‡æ¡£](./architecture.md)
- [æœ¬åœ°å¼€å‘æŒ‡å—](./local-development-guide.md)
- [CLAUDE.md é¡¹ç›®è¯´æ˜](../CLAUDE.md)
