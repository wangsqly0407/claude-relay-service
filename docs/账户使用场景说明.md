# 账户使用场景说明

## 三种账户模式对比

### 1. 共享账户（默认模式）

**定义**：供所有API Key使用的公共资源池

**工作原理**：
- 账户不配置任何特殊限制（不绑定allowedApiKeyIds，不加入分组）
- 所有API Key通过统一调度器自动选择可用账户
- 调度器根据账户负载、粘性会话、模型支持等因素智能分配

**适用场景**：
- 大量小额用户（如闲鱼订单用户）
- 用户消费额度可预测且固定
- 对服务质量要求不高，可接受一定程度的资源竞争
- 短期使用（如一周体验卡）
- 成本敏感的场景

**优点**：
- 资源利用率最高，成本最低
- 管理简单，无需为每个用户单独配置
- 灵活调度，自动负载均衡
- 账户故障时自动切换

**缺点**：
- 用户之间可能互相影响
- 高并发用户可能影响其他用户的响应速度
- 难以精确追踪单个用户的账户使用情况
- 一个账户被限流可能影响多个用户

**配置方法**：
```javascript
// 账户配置：无需特殊配置，默认就是共享账户
// 只需确保账户 isActive=true, status='active'

// API Key配置：不绑定账户
{
  name: "体验卡_001",
  quotaLimit: 20.0,          // 限制20美元用量
  expiresAt: "2026-01-18",   // 一周后过期
  concurrencyLimit: 3,       // 最大3个并发请求
  // 不设置 claudeAccountId, geminiAccountId 等字段
}
```

**成本控制建议**：
- 使用 `quotaLimit` 严格限制每个API Key的消费额度
- 使用 `concurrencyLimit` 防止单个用户占用过多资源
- 使用 `expiresAt` 设置时间限制
- 监控全局使用量，及时调整账户池大小

---

### 2. 专属账户（独占模式）

**定义**：仅供特定API Key使用的独占账户

**工作原理**：
- API Key绑定特定账户ID（如 `claudeAccountId='account-xxx'`）
- 该API Key的所有请求都路由到绑定的账户
- 其他API Key无法使用该账户（除非也绑定到同一账户）

**适用场景**：
- 高价值客户（包月/包年套餐）
- 需要独占资源和服务质量保障
- 企业客户，需要独立计费和审计
- 对响应速度和稳定性要求极高
- 需要精确的使用统计和成本归属

**优点**：
- 完全隔离，不受其他用户影响
- 性能稳定可预测
- 精确的使用统计和成本计算
- 易于故障排查和问题定位
- 符合企业级SLA要求

**缺点**：
- 成本最高，每个客户需要独立账户
- 资源利用率低（账户闲置时浪费）
- 管理复杂，账户数量与客户数量成正比
- 账户故障时用户服务中断（除非配置fallback）

**配置方法**：
```javascript
// 1. 创建账户（Claude OAuth账户为例）
// 在Web管理界面添加账户，获得accountId

// 2. 配置API Key绑定专属账户
{
  name: "企业客户_001",
  quotaLimit: 0,                          // 0表示不限额度
  claudeAccountId: "account-uuid-xxx",    // 绑定专属Claude账户
  concurrencyLimit: 10,                   // 较高的并发限制
  expiresAt: "2027-01-11",                // 长期有效
}

// 3. 该API Key的所有Claude请求都会使用 account-uuid-xxx
```

**成本考虑**：
- 每个用户需要独立的Claude/Gemini账户（成本高）
- 适合月费≥50元以上的套餐
- 闲鱼体验卡（9.9元/20刀）不适合此模式

---

### 3. 分组调度（混合模式）

**定义**：账户加入分组，API Key在分组内调度

**工作原理**：
- 创建账户分组（如"VIP用户组"、"普通用户组"）
- 多个账户加入同一分组
- API Key绑定分组（如 `claudeAccountId='group:group-xxx'`）
- 该API Key在分组内的账户中智能调度

**适用场景**：
- 中等规模用户群体
- 需要分级服务（VIP组、普通组、体验组）
- 按用户等级分配不同的资源池
- 需要一定隔离但又要保持成本优化
- 同一组用户可接受资源共享

**优点**：
- 兼顾资源利用率和服务质量
- 支持分级服务策略
- 成本低于专属账户，质量高于完全共享
- 灵活调整分组策略
- 组内账户可负载均衡和故障转移

**缺点**：
- 配置相对复杂，需要规划分组策略
- 组内用户仍可能互相影响
- 需要定期调整分组和账户分配
- 管理成本高于纯共享模式

**配置方法**：
```javascript
// 1. 创建账户分组（通过管理界面或API）
POST /admin/account-groups
{
  name: "体验用户组",
  platform: "claude",
  description: "闲鱼体验卡用户专用分组"
}
// 返回: { id: "group-uuid-xxx", ... }

// 2. 将账户加入分组（在账户管理界面配置）
// 将 2-3 个Claude账户加入"体验用户组"

// 3. 配置API Key绑定分组
{
  name: "体验卡_001",
  quotaLimit: 20.0,
  claudeAccountId: "group:group-uuid-xxx",  // 绑定分组（注意group:前缀）
  concurrencyLimit: 3,
  expiresAt: "2026-01-18",
}

// 4. 该API Key的请求会在"体验用户组"内的账户中调度
```

**分组策略建议**：
- 体验用户组：2-3个账户，每组支持10-20个并发用户
- VIP用户组：专用账户池，更高配额和并发限制
- 企业用户组：独立分组，配置监控和告警

---

## 闲鱼订单用户推荐方案

### 用户特征分析

**闲鱼体验卡用户画像**：
- 单价：9.9元/20美元用量
- 时效：一周使用期限
- 用量：20美元（约10万token input + 10万token output）
- 用户类型：个人开发者、学生、临时使用者
- 成本敏感度：高（低价体验）
- 服务质量要求：中等（可接受偶尔的速度波动）

### 推荐方案

#### 方案一：共享账户 + 严格Quota限制（强烈推荐）

**配置示例**：
```javascript
// API Key配置
{
  name: "20刀体验_[订单号]",
  quotaLimit: 20.0,              // 严格限制20美元
  expiresAt: "一周后日期",
  concurrencyLimit: 3,           // 最多3个并发（防止单用户占用）
  concurrentRequestQueueEnabled: true,     // 启用并发排队
  concurrentRequestQueueMaxSize: 5,        // 排队最多5个
  concurrentRequestQueueTimeoutMs: 10000,  // 10秒超时
  rateLimitWindow: 60,           // 可选：每分钟限流
  rateLimitRequests: 30,         // 可选：每分钟最多30请求
}
```

**优点**：
- 成本最低，无需为每个用户准备独立账户
- 管理简单，自动发货即可
- 资源利用率高
- 适合大规模订单（100+用户）

**实施要点**：
1. 准备3-5个Claude OAuth账户作为共享池
2. 确保每个账户都配置了代理（如果需要）
3. 启用粘性会话（STICKY_SESSION_TTL_HOURS=1）保证对话连续性
4. 监控账户池使用情况，及时补充账户
5. 设置Webhook通知，账户余额不足时告警

**成本估算**（假设Claude Pro账户20$/月）：
- 20$/月可支持约50个体验卡用户（50×20刀=1000刀理论消费）
- 实际用户不会用满20刀，按平均10刀计算，可支持100个用户
- 营收：100×9.9=990元，成本：20×7.3=146元，毛利约85%

---

#### 方案二：分组调度（用户量大时推荐）

**使用场景**：
- 每天订单量 > 20单
- 需要区分用户等级（体验用户、续费用户、VIP用户）
- 希望提供差异化服务质量

**配置示例**：
```javascript
// 1. 创建"体验用户组"，加入2-3个账户
// 2. API Key配置
{
  name: "20刀体验_[订单号]",
  claudeAccountId: "group:experience-users",  // 绑定体验用户组
  quotaLimit: 20.0,
  expiresAt: "一周后",
  concurrencyLimit: 3,
}
```

**优点**：
- 体验用户与付费用户隔离，互不影响
- 可根据业务增长灵活调整分组
- 监控和统计更精确

**成本**：
- 稍高于共享模式（需要多个分组的账户）
- 适合月订单量 > 500单的场景

---

#### 方案三：专属账户（不推荐）

**原因**：
- 成本过高：每个9.9元用户需要独立账户（账户成本远超营收）
- 管理复杂：100个用户需要100个账户
- 资源浪费：用户只用一周，账户长期闲置
- **仅适合月费≥50元的包月套餐**

---

## 实施建议

### 初期（订单量 < 50单/月）
- 使用**共享账户模式**
- 准备3个Claude OAuth账户
- 严格配置quotaLimit和expiresAt
- 监控使用量和成本

### 成长期（订单量 50-200单/月）
- 扩展共享账户池到5-8个
- 考虑引入**分组调度**区分用户等级
- 创建"体验组"和"VIP组"

### 成熟期（订单量 > 200单/月）
- 完善分组策略：体验组、续费组、VIP组、企业组
- 为高价值客户提供**专属账户**选项（单独SKU）
- 实施自动化监控和告警
- 定期清理过期的API Key和账户

### 技术要点

**必须配置的环境变量**：
```bash
# 粘性会话（确保对话连续性）
STICKY_SESSION_TTL_HOURS=1
STICKY_SESSION_RENEWAL_THRESHOLD_MINUTES=30

# 并发控制
# 不使用USER_MESSAGE_QUEUE，改用并发排队
CONCURRENT_REQUEST_QUEUE_ENABLED=true  # 在API Key级别启用

# 实时监控窗口
METRICS_WINDOW=5  # 5分钟实时指标

# Webhook告警
WEBHOOK_ENABLED=true
WEBHOOK_URLS=https://your-webhook.com/alert
```

**监控指标**：
- 每日新增API Key数量
- 账户池使用率（并发数/账户总数）
- 平均每个体验卡实际消费（是否接近20刀）
- 账户余额告警
- 529错误频率（账户过载）

**自动化脚本**：
```bash
# 定时清理过期API Key（每天执行）
crontab: 0 2 * * * cd /path/to/project && npm run cli keys cleanup

# 监控账户余额（每小时执行）
crontab: 0 * * * * cd /path/to/project && node scripts/check-account-balance.js
```

---

## 总结

**针对闲鱼9.9元/20刀体验卡用户**：

| 维度 | 推荐方案 | 原因 |
|------|---------|------|
| **首选** | 共享账户 + Quota限制 | 成本低、管理简单、适合大规模 |
| **备选** | 分组调度 | 用户量大时提供差异化服务 |
| **不推荐** | 专属账户 | 成本过高，不经济 |

**关键配置**：
- `quotaLimit: 20.0` - 严格限制额度
- `expiresAt` - 一周后过期
- `concurrencyLimit: 3` - 防止资源占用
- 共享账户池：3-5个Claude账户
- 启用粘性会话和并发排队

**成本优化**：
- 监控实际消费，大部分用户不会用满20刀
- 按实际消费调整定价策略
- 提供续费优惠引导用户购买包月套餐（使用专属账户）
